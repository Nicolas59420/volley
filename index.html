<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur de tournoi de Volley Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .transition-all { transition: all 0.3s ease-in-out; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .draggable-item { cursor: move; }
        .draggable-item:hover { background-color: #e0e7ff; transform: scale(1.02); }
        .drop-zone { min-height: 100px; border: 2px dashed #d1d5db; background-color: #f9fafb; }
        .sortable-ghost { opacity: 0.4; background: #c7d2fe; }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); z-index: 40;
        }
        .modal {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); z-index: 50;
        }
        .dist-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
        }
        .dist-btn.active {
            background-color: white;
            color: #4f46e5; /* indigo-600 */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Section de configuration multi-√©tapes -->
        <div id="setup-section" class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-lg fade-in">
            
            <!-- √âtape 1: Configuration de base -->
            <div id="step-1">
                <h1 class="text-3xl font-bold text-center text-blue-600 mb-2">G√©n√©rateur de tournoi de Volley üèê</h1>
                <p class="text-center text-gray-500 mb-8">Organisez vos matchs en quelques clics.</p>
                <div class="space-y-6">
                    <div>
                        <label for="team-count-initial" class="block text-sm font-medium text-gray-700 mb-2">Nombre d'√©quipes de d√©part</label>
                        <input type="number" id="team-count-initial" min="4" max="17" value="8" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition-all">
                    </div>
                    <div>
                        <label for="start-time" class="block text-sm font-medium text-gray-700 mb-2">Heure de d√©but du tournoi ‚è∞</label>
                        <input type="time" id="start-time" value="09:00" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition-all">
                    </div>
                </div>
                <button id="next-to-step-2" class="mt-8 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transform hover:scale-105">
                    Suivant ‚û°Ô∏è
                </button>
            </div>

            <!-- √âtape 2: Noms des √©quipes et joueurs -->
            <div id="step-2" class="hidden">
                <h2 class="text-2xl font-bold text-center text-blue-600 mb-6">Noms des √âquipes et Joueurs üßë‚Äçü§ù‚Äçüßë</h2>
                <div id="teams-inputs-container" class="space-y-4"></div>
                <div class="flex justify-center gap-4 mt-6">
                    <button id="add-team-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transform hover:scale-105">‚ûï Ajouter une √©quipe</button>
                </div>
                <div class="flex justify-between mt-8">
                    <button class="nav-btn bg-gray-500" id="back-to-step-1">‚¨ÖÔ∏è Pr√©c√©dent</button>
                    <button class="nav-btn bg-blue-600" id="next-to-step-3">Suivant ‚û°Ô∏è</button>
                </div>
            </div>

            <!-- √âtape 3: Cr√©ation des poules -->
            <div id="step-3" class="hidden">
                <h2 class="text-2xl font-bold text-center text-blue-600 mb-2">R√©partition des Poules üèÜ</h2>
                <p class="text-center text-gray-500 mb-6">Choisissez comment r√©partir les √©quipes.</p>
                
                <div class="flex justify-center gap-2 mb-6 border border-gray-200 rounded-lg p-1 bg-gray-100 w-max mx-auto">
                    <button id="manual-dist-btn" class="dist-btn">Manuelle üñêÔ∏è</button>
                    <button id="auto-dist-btn" class="dist-btn">Automatique üé≤</button>
                </div>

                <div id="dnd-interface">
                    <p class="text-center text-gray-500 mb-4">Glissez-d√©posez les √©quipes pour former les poules.</p>
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <div class="lg:col-span-1">
                            <h3 class="font-semibold mb-2 text-center">√âquipes √† r√©partir</h3>
                            <div id="unassigned-teams" class="p-4 rounded-lg space-y-2 drop-zone"></div>
                        </div>
                        <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-6" id="pools-container"></div>
                    </div>
                </div>

                <div id="auto-dist-message" class="hidden text-center p-8 bg-blue-50 rounded-lg">
                    <p class="text-blue-700 font-medium">Les √©quipes seront r√©parties al√©atoirement dans les poules. C'est parti ! üöÄ</p>
                </div>

                <div class="flex justify-between mt-8">
                    <button class="nav-btn bg-gray-500" id="back-to-step-2">‚¨ÖÔ∏è Pr√©c√©dent</button>
                    <button id="generate-btn" class="nav-btn bg-green-600">G√©n√©rer le planning ‚ú®</button>
                </div>
            </div>
            
            <div id="error-message" class="text-red-500 text-center mt-4 font-medium"></div>
        </div>

        <!-- Section d'affichage du planning (inchang√©e) -->
        <div id="schedule-section" class="hidden mt-12 fade-in">
            <!-- ... Le contenu du planning reste le m√™me ... -->
        </div>
    </div>
    
    <!-- Modal pour la gestion des joueurs (inchang√©) -->
    <div id="player-modal" class="hidden">
        <!-- ... Le contenu du modal reste le m√™me ... -->
    </div>

    <script>
        // --- √âTAT GLOBAL DE L'APPLICATION ---
        const AppState = {
            teams: [],
            startTime: '09:00',
            editingTeamIndex: null,
            distributionMode: 'manual', // 'manual' ou 'automatic'
        };

        // --- S√âLECTION DES √âL√âMENTS DU DOM ---
        const setupSection = document.getElementById('setup-section');
        const scheduleSection = document.getElementById('schedule-section');
        const errorMessage = document.getElementById('error-message');
        const steps = { step1: document.getElementById('step-1'), step2: document.getElementById('step-2'), step3: document.getElementById('step-3') };
        const playerModal = document.getElementById('player-modal');
        const manualDistBtn = document.getElementById('manual-dist-btn');
        const autoDistBtn = document.getElementById('auto-dist-btn');
        const dndInterface = document.getElementById('dnd-interface');
        const autoDistMessage = document.getElementById('auto-dist-message');

        // --- GESTIONNAIRES D'√âV√âNEMENTS PRINCIPAUX ---
        document.getElementById('next-to-step-2').addEventListener('click', () => navigateToStep(2));
        document.getElementById('back-to-step-1').addEventListener('click', () => navigateToStep(1));
        document.getElementById('next-to-step-3').addEventListener('click', () => navigateToStep(3));
        document.getElementById('back-to-step-2').addEventListener('click', () => navigateToStep(2));
        document.getElementById('generate-btn').addEventListener('click', generateSchedule);
        document.getElementById('add-team-btn').addEventListener('click', addTeam);
        manualDistBtn.addEventListener('click', () => setDistributionMode('manual'));
        autoDistBtn.addEventListener('click', () => setDistributionMode('automatic'));

        // --- FONCTION DE M√âLANGE ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- LOGIQUE DE NAVIGATION ---
        function navigateToStep(stepNumber) {
            errorMessage.textContent = '';
            
            if (stepNumber === 2) {
                const initialCount = parseInt(document.getElementById('team-count-initial').value);
                if (AppState.teams.length === 0) {
                    AppState.teams = Array.from({ length: initialCount }, (_, i) => ({
                        id: `team-${Date.now()}-${i}`, name: `√âquipe ${i + 1}`, players: []
                    }));
                }
                AppState.startTime = document.getElementById('start-time').value;
                renderTeamInputs();
            }

            if (stepNumber === 3) {
                if (!saveTeamNames()) return;
                if (AppState.teams.length < 4 || AppState.teams.length > 17) {
                    errorMessage.textContent = "Le nombre d'√©quipes doit √™tre compris entre 4 et 17.";
                    return;
                }
                setupDragAndDrop();
                setDistributionMode(AppState.distributionMode); // Applique le mode actuel
            }

            Object.values(steps).forEach(step => step.classList.add('hidden'));
            steps[`step${stepNumber}`].classList.remove('hidden');
            steps[`step${stepNumber}`].classList.add('fade-in');
        }

        // --- GESTION DE LA R√âPARTITION (√âTAPE 3) ---
        function setDistributionMode(mode) {
            AppState.distributionMode = mode;
            if (mode === 'manual') {
                manualDistBtn.classList.add('active');
                autoDistBtn.classList.remove('active');
                dndInterface.classList.remove('hidden');
                autoDistMessage.classList.add('hidden');
            } else {
                autoDistBtn.classList.add('active');
                manualDistBtn.classList.remove('active');
                dndInterface.classList.add('hidden');
                autoDistMessage.classList.remove('hidden');
            }
        }

        // --- LOGIQUE DE G√âN√âRATION (MISE √Ä JOUR) ---
        function generateSchedule() {
            errorMessage.textContent = '';
            let groups;

            if (AppState.distributionMode === 'manual') {
                const groupsElements = document.querySelectorAll('.pool-zone');
                groups = Array.from(groupsElements).map(poolEl => 
                    Array.from(poolEl.querySelectorAll('.draggable-item')).map(teamEl => teamEl.textContent)
                );
                
                const totalTeamsInPools = groups.reduce((acc, group) => acc + group.length, 0);
                if (totalTeamsInPools !== AppState.teams.length) {
                    errorMessage.textContent = "Veuillez r√©partir toutes les √©quipes dans les poules.";
                    return;
                }
            } else { // Mode automatique
                const teamNames = shuffleArray(AppState.teams.map(t => t.name));
                const numGroups = AppState.teams.length < 9 ? 2 : 3;
                groups = Array.from({ length: numGroups }, () => []);
                teamNames.forEach((teamName, index) => {
                    groups[index % numGroups].push(teamName);
                });
            }

            let allMatches = [];
            groups.forEach((group, groupIndex) => {
                for (let i = 0; i < group.length; i++) {
                    for (let j = i + 1; j < group.length; j++) {
                        allMatches.push({ team1: group[i], team2: group[j], groupIndex: groupIndex });
                    }
                }
            });
            
            const schedule = planMatches(allMatches, groups);
            const { startTime, totalSlotDuration } = calculateTimings(schedule.length);

            if (!startTime) return;

            // Le reste est identique
            displayGroups(groups);
            displaySchedule(schedule, startTime, totalSlotDuration);
            // prepareCsvData(schedule, startTime, totalSlotDuration); // Cette fonction doit √™tre d√©finie

            setupSection.classList.add('hidden');
            scheduleSection.classList.remove('hidden');
        }

        // --- Le reste du code JavaScript (gestion des √©quipes, joueurs, D&D, affichage, etc.) reste identique √† la version pr√©c√©dente ---
        // ... (Collez ici TOUT le reste du script de la v3, de `renderTeamInputs` √† la fin)
        
        // --- GESTION DES √âQUIPES (√âTAPE 2) ---
        function renderTeamInputs() {
            const container = document.getElementById('teams-inputs-container');
            container.innerHTML = '';
            AppState.teams.forEach((team, index) => {
                const teamCard = document.createElement('div');
                teamCard.className = "bg-gray-50 p-4 rounded-lg border flex items-center gap-4";
                teamCard.innerHTML = `
                    <div class="flex-grow">
                        <label class="block text-sm font-medium text-gray-700">√âquipe ${index + 1}</label>
                        <input type="text" value="${team.name}" data-index="${index}" class="team-name-input w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500" required>
                    </div>
                    <button class="manage-players-btn px-3 py-2 bg-indigo-500 text-white text-sm rounded-lg hover:bg-indigo-600" data-index="${index}">‚úèÔ∏è G√©rer Joueurs (${team.players.length})</button>
                    <button class="remove-team-btn px-3 py-2 bg-red-500 text-white text-sm rounded-lg hover:bg-red-600" data-index="${index}">üóëÔ∏è</button>
                `;
                container.appendChild(teamCard);
            });
            container.querySelectorAll('.manage-players-btn').forEach(btn => btn.addEventListener('click', (e) => openPlayerModal(e.currentTarget.dataset.index)));
            container.querySelectorAll('.remove-team-btn').forEach(btn => btn.addEventListener('click', (e) => removeTeam(e.currentTarget.dataset.index)));
        }
        
        function addTeam() {
            const newIndex = AppState.teams.length;
            AppState.teams.push({ id: `team-${Date.now()}-${newIndex}`, name: `√âquipe ${newIndex + 1}`, players: [] });
            renderTeamInputs();
        }

        function removeTeam(index) {
            AppState.teams.splice(index, 1);
            renderTeamInputs();
        }

        function saveTeamNames() {
            const nameInputs = document.querySelectorAll('.team-name-input');
            let allNamesValid = true;
            nameInputs.forEach(input => {
                const index = input.dataset.index;
                if (input.value.trim() === '') {
                    errorMessage.textContent = `Le nom de l'√©quipe ${parseInt(index) + 1} ne peut pas √™tre vide.`;
                    allNamesValid = false;
                }
                AppState.teams[index].name = input.value.trim();
            });
            return allNamesValid;
        }

        // --- GESTION DES JOUEURS (MODAL) ---
        function openPlayerModal(index) { /* ... */ }
        function renderModalPlayerList() { /* ... */ }
        playerModal.addEventListener('click', (e) => { /* ... */ });

        // --- DRAG & DROP (√âTAPE 3) ---
        function setupDragAndDrop() { /* ... */ }
        
        // --- LOGIQUE DE PLANIFICATION & CALCULS ---
        function planMatches(allMatches, groups) { /* ... */ }
        function calculateTimings(numRounds) { /* ... */ }

        // --- AFFICHAGE DU PLANNING ---
        function displayGroups(groups) { /* ... */ }
        function displaySchedule(schedule, startTime, totalSlotDuration) { /* ... */ }
        
        // --- FONCTIONS CSV ET UTILITAIRES ---
        function downloadCsv() { /* ... */ }
        function formatTime(date) { /* ... */ }

        // --- STYLES DYNAMIQUES ---
        // ...
    </script>
</body>
</html>
