<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur de tournoi de Volley Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .transition-all { transition: all 0.3s ease-in-out; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .draggable-item { cursor: move; }
        .draggable-item:hover { background-color: #e0e7ff; transform: scale(1.02); }
        .drop-zone { min-height: 100px; border: 2px dashed #d1d5db; background-color: #f9fafb; }
        .sortable-ghost { opacity: 0.4; background: #c7d2fe; }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); z-index: 40;
        }
        .modal {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); z-index: 50;
        }
        .dist-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
        }
        .dist-btn.active {
            background-color: white;
            color: #4f46e5; /* indigo-600 */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Section de configuration multi-√©tapes -->
        <div id="setup-section" class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-lg fade-in">
            
            <!-- √âtape 1: Configuration de base -->
            <div id="step-1">
                <h1 class="text-3xl font-bold text-center text-blue-600 mb-2">G√©n√©rateur de tournoi de Volley üèê</h1>
                <p class="text-center text-gray-500 mb-8">Organisez vos matchs en quelques clics.</p>
                <div class="space-y-6">
                    <div>
                        <label for="team-count-initial" class="block text-sm font-medium text-gray-700 mb-2">Nombre d'√©quipes de d√©part</label>
                        <input type="number" id="team-count-initial" min="4" max="17" value="8" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition-all">
                    </div>
                    <div>
                        <label for="start-time" class="block text-sm font-medium text-gray-700 mb-2">Heure de d√©but du tournoi ‚è∞</label>
                        <input type="time" id="start-time" value="09:00" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition-all">
                    </div>
                </div>
                <button id="next-to-step-2" class="mt-8 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transform hover:scale-105">
                    Suivant ‚û°Ô∏è
                </button>
            </div>

            <!-- √âtape 2: Noms des √©quipes et joueurs -->
            <div id="step-2" class="hidden">
                <h2 class="text-2xl font-bold text-center text-blue-600 mb-6">Noms des √âquipes et Joueurs üßë‚Äçü§ù‚Äçüßë</h2>
                <div id="teams-inputs-container" class="space-y-4"></div>
                <div class="flex justify-center gap-4 mt-6">
                    <button id="add-team-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transform hover:scale-105">‚ûï Ajouter une √©quipe</button>
                </div>
                <div class="flex justify-between mt-8">
                    <button class="nav-btn bg-gray-500" id="back-to-step-1">‚¨ÖÔ∏è Pr√©c√©dent</button>
                    <button class="nav-btn bg-blue-600" id="next-to-step-3">Suivant ‚û°Ô∏è</button>
                </div>
            </div>

            <!-- √âtape 3: Cr√©ation des poules -->
            <div id="step-3" class="hidden">
                <h2 class="text-2xl font-bold text-center text-blue-600 mb-2">R√©partition des Poules üèÜ</h2>
                <p class="text-center text-gray-500 mb-6">Choisissez comment r√©partir les √©quipes.</p>
                
                <div class="flex justify-center gap-2 mb-6 border border-gray-200 rounded-lg p-1 bg-gray-100 w-max mx-auto">
                    <button id="manual-dist-btn" class="dist-btn">Manuelle üñêÔ∏è</button>
                    <button id="auto-dist-btn" class="dist-btn">Automatique üé≤</button>
                </div>

                <div id="dnd-interface">
                    <p class="text-center text-gray-500 mb-4">Glissez-d√©posez les √©quipes pour former les poules.</p>
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <div class="lg:col-span-1">
                            <h3 class="font-semibold mb-2 text-center">√âquipes √† r√©partir</h3>
                            <div id="unassigned-teams" class="p-4 rounded-lg space-y-2 drop-zone"></div>
                        </div>
                        <div class="lg-col-span-3 grid grid-cols-1 md:grid-cols-2 gap-6" id="pools-container"></div>
                    </div>
                </div>

                <div id="auto-dist-message" class="hidden text-center p-8 bg-blue-50 rounded-lg">
                    <p class="text-blue-700 font-medium">Les √©quipes seront r√©parties al√©atoirement dans les poules. C'est parti ! üöÄ</p>
                </div>

                <div class="flex justify-between mt-8">
                    <button class="nav-btn bg-gray-500" id="back-to-step-2">‚¨ÖÔ∏è Pr√©c√©dent</button>
                    <button id="generate-btn" class="nav-btn bg-green-600">G√©n√©rer le planning ‚ú®</button>
                </div>
            </div>
            
            <div id="error-message" class="text-red-500 text-center mt-4 font-medium"></div>
        </div>

        <!-- Section d'affichage du planning -->
        <div id="schedule-section" class="hidden mt-12 fade-in">
            <div class="max-w-7xl mx-auto">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-blue-600">Planning du tournoi üìã</h2>
                    <p id="schedule-summary" class="text-gray-500 mt-2"></p>
                </div>
                <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-8">
                    <button id="download-csv-btn" class="action-btn bg-green-600 hover:bg-green-700 focus:ring-green-300">üìÑ T√©l√©charger en CSV</button>
                    <button id="back-to-setup" class="action-btn bg-gray-600 hover:bg-gray-700 focus:ring-gray-300">üîÑ Recommencer</button>
                </div>
                <div id="groups-display" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8"></div>
                <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-lg overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="th-style">Heure</th>
                                <th class="th-style">Terrain</th>
                                <th class="th-style">Match</th>
                                <th class="th-style">Score</th>
                                <th class="th-style">Arbitre</th>
                            </tr>
                        </thead>
                        <tbody id="schedule-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal pour la gestion des joueurs -->
    <div id="player-modal" class="hidden">
        <div class="modal-backdrop"></div>
        <div class="modal w-full max-w-md bg-white rounded-2xl shadow-xl p-6">
            <h3 class="text-xl font-bold mb-4" id="modal-team-name">G√©rer les joueurs</h3>
            <div id="modal-players-list" class="space-y-2 mb-4 max-h-60 overflow-y-auto"></div>
            <div class="flex gap-2">
                <input type="text" id="new-player-name" placeholder="Nom du nouveau joueur" class="flex-grow px-3 py-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500">
                <button id="add-player-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Ajouter</button>
            </div>
            <button id="close-modal-btn" class="mt-6 w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Fermer</button>
        </div>
    </div>

    <script>
        // --- √âTAT GLOBAL DE L'APPLICATION ---
        const AppState = {
            teams: [],
            startTime: '09:00',
            editingTeamIndex: null,
            distributionMode: 'manual', // 'manual' ou 'automatic'
            scheduleDataForCsv: [],
        };

        // --- S√âLECTION DES √âL√âMENTS DU DOM ---
        const setupSection = document.getElementById('setup-section');
        const scheduleSection = document.getElementById('schedule-section');
        const errorMessage = document.getElementById('error-message');
        const steps = { step1: document.getElementById('step-1'), step2: document.getElementById('step-2'), step3: document.getElementById('step-3') };
        const playerModal = document.getElementById('player-modal');
        const manualDistBtn = document.getElementById('manual-dist-btn');
        const autoDistBtn = document.getElementById('auto-dist-btn');
        const dndInterface = document.getElementById('dnd-interface');
        const autoDistMessage = document.getElementById('auto-dist-message');

        // --- GESTIONNAIRES D'√âV√âNEMENTS PRINCIPAUX ---
        document.getElementById('next-to-step-2').addEventListener('click', () => navigateToStep(2));
        document.getElementById('back-to-step-1').addEventListener('click', () => navigateToStep(1));
        document.getElementById('next-to-step-3').addEventListener('click', () => navigateToStep(3));
        document.getElementById('back-to-step-2').addEventListener('click', () => navigateToStep(2));
        document.getElementById('generate-btn').addEventListener('click', generateSchedule);
        document.getElementById('add-team-btn').addEventListener('click', addTeam);
        document.getElementById('back-to-setup').addEventListener('click', () => {
            scheduleSection.classList.add('hidden');
            setupSection.classList.remove('hidden');
            navigateToStep(1);
        });
        document.getElementById('download-csv-btn').addEventListener('click', downloadCsv);
        manualDistBtn.addEventListener('click', () => setDistributionMode('manual'));
        autoDistBtn.addEventListener('click', () => setDistributionMode('automatic'));

        // --- FONCTION DE M√âLANGE ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- LOGIQUE DE NAVIGATION ---
        function navigateToStep(stepNumber) {
            errorMessage.textContent = '';
            
            if (stepNumber === 2) {
                const initialCount = parseInt(document.getElementById('team-count-initial').value);
                if (AppState.teams.length === 0) {
                    AppState.teams = Array.from({ length: initialCount }, (_, i) => ({
                        id: `team-${Date.now()}-${i}`, name: `√âquipe ${i + 1}`, players: []
                    }));
                }
                AppState.startTime = document.getElementById('start-time').value;
                renderTeamInputs();
            }

            if (stepNumber === 3) {
                if (!saveTeamNames()) return;
                if (AppState.teams.length < 4 || AppState.teams.length > 17) {
                    errorMessage.textContent = "Le nombre d'√©quipes doit √™tre compris entre 4 et 17.";
                    return;
                }
                setupDragAndDrop();
                setDistributionMode(AppState.distributionMode);
            }

            Object.values(steps).forEach(step => step.classList.add('hidden'));
            steps[`step${stepNumber}`].classList.remove('hidden');
            steps[`step${stepNumber}`].classList.add('fade-in');
        }

        // --- GESTION DE LA R√âPARTITION (√âTAPE 3) ---
        function setDistributionMode(mode) {
            AppState.distributionMode = mode;
            if (mode === 'manual') {
                manualDistBtn.classList.add('active');
                autoDistBtn.classList.remove('active');
                dndInterface.classList.remove('hidden');
                autoDistMessage.classList.add('hidden');
            } else {
                autoDistBtn.classList.add('active');
                manualDistBtn.classList.remove('active');
                dndInterface.classList.add('hidden');
                autoDistMessage.classList.remove('hidden');
            }
        }

        // --- LOGIQUE DE G√âN√âRATION (MISE √Ä JOUR) ---
        function generateSchedule() {
            errorMessage.textContent = '';
            let groups;

            if (AppState.distributionMode === 'manual') {
                const groupsElements = document.querySelectorAll('.pool-zone');
                groups = Array.from(groupsElements).map(poolEl => 
                    Array.from(poolEl.querySelectorAll('.draggable-item')).map(teamEl => teamEl.textContent)
                );
                
                const totalTeamsInPools = groups.reduce((acc, group) => acc + group.length, 0);
                if (totalTeamsInPools !== AppState.teams.length) {
                    errorMessage.textContent = "Veuillez r√©partir toutes les √©quipes dans les poules.";
                    return;
                }
            } else { // Mode automatique
                const teamNames = shuffleArray(AppState.teams.map(t => t.name));
                const numGroups = AppState.teams.length < 9 ? 2 : 3;
                groups = Array.from({ length: numGroups }, () => []);
                teamNames.forEach((teamName, index) => {
                    groups[index % numGroups].push(teamName);
                });
            }

            let allMatches = [];
            groups.forEach((group, groupIndex) => {
                for (let i = 0; i < group.length; i++) {
                    for (let j = i + 1; j < group.length; j++) {
                        allMatches.push({ team1: group[i], team2: group[j], groupIndex: groupIndex });
                    }
                }
            });
            
            const schedule = planMatches(allMatches, groups);
            const { startTime, totalSlotDuration } = calculateTimings(schedule.length);

            if (!startTime) return;

            displayGroups(groups);
            displaySchedule(schedule, startTime, totalSlotDuration);

            setupSection.classList.add('hidden');
            scheduleSection.classList.remove('hidden');
        }
        
        // --- GESTION DES √âQUIPES (√âTAPE 2) ---
        function renderTeamInputs() {
            const container = document.getElementById('teams-inputs-container');
            container.innerHTML = '';
            AppState.teams.forEach((team, index) => {
                const teamCard = document.createElement('div');
                teamCard.className = "bg-gray-50 p-4 rounded-lg border flex items-center gap-4";
                teamCard.innerHTML = `
                    <div class="flex-grow">
                        <label class="block text-sm font-medium text-gray-700">√âquipe ${index + 1}</label>
                        <input type="text" value="${team.name}" data-index="${index}" class="team-name-input w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500" required>
                    </div>
                    <button class="manage-players-btn px-3 py-2 bg-indigo-500 text-white text-sm rounded-lg hover:bg-indigo-600" data-index="${index}">‚úèÔ∏è G√©rer Joueurs (${team.players.length})</button>
                    <button class="remove-team-btn px-3 py-2 bg-red-500 text-white text-sm rounded-lg hover:bg-red-600" data-index="${index}">üóëÔ∏è</button>
                `;
                container.appendChild(teamCard);
            });
            container.querySelectorAll('.manage-players-btn').forEach(btn => btn.addEventListener('click', (e) => openPlayerModal(e.currentTarget.dataset.index)));
            container.querySelectorAll('.remove-team-btn').forEach(btn => btn.addEventListener('click', (e) => removeTeam(e.currentTarget.dataset.index)));
        }
        
        function addTeam() {
            const newIndex = AppState.teams.length;
            AppState.teams.push({ id: `team-${Date.now()}-${newIndex}`, name: `√âquipe ${newIndex + 1}`, players: [] });
            renderTeamInputs();
        }

        function removeTeam(index) {
            AppState.teams.splice(index, 1);
            renderTeamInputs();
        }

        function saveTeamNames() {
            const nameInputs = document.querySelectorAll('.team-name-input');
            let allNamesValid = true;
            nameInputs.forEach(input => {
                const index = input.dataset.index;
                if (input.value.trim() === '') {
                    errorMessage.textContent = `Le nom de l'√©quipe ${parseInt(index) + 1} ne peut pas √™tre vide.`;
                    allNamesValid = false;
                }
                AppState.teams[index].name = input.value.trim();
            });
            return allNamesValid;
        }

        // --- GESTION DES JOUEURS (MODAL) ---
        function openPlayerModal(index) {
            AppState.editingTeamIndex = parseInt(index);
            const team = AppState.teams[AppState.editingTeamIndex];
            document.getElementById('modal-team-name').textContent = `G√©rer les joueurs de : ${team.name}`;
            renderModalPlayerList();
            playerModal.classList.remove('hidden');
        }
        
        function renderModalPlayerList() {
            const listContainer = document.getElementById('modal-players-list');
            const team = AppState.teams[AppState.editingTeamIndex];
            listContainer.innerHTML = '';
            if (team.players.length === 0) {
                listContainer.innerHTML = `<p class="text-gray-500 text-center">Aucun joueur ajout√©.</p>`;
                return;
            }
            team.players.forEach((player, playerIndex) => {
                const playerEl = document.createElement('div');
                playerEl.className = "flex items-center justify-between bg-gray-100 p-2 rounded";
                playerEl.innerHTML = `
                    <span class="player-name">${player}</span>
                    <input type="text" class="player-edit-input hidden flex-grow px-2 py-1 border rounded" value="${player}">
                    <div>
                        <button class="edit-player-btn text-blue-500 hover:text-blue-700 p-1" data-player-index="${playerIndex}">‚úèÔ∏è</button>
                        <button class="save-player-btn text-green-500 hover:text-green-700 p-1 hidden" data-player-index="${playerIndex}">‚úîÔ∏è</button>
                        <button class="delete-player-btn text-red-500 hover:text-red-700 p-1" data-player-index="${playerIndex}">üóëÔ∏è</button>
                    </div>
                `;
                listContainer.appendChild(playerEl);
            });
        }
        
        playerModal.addEventListener('click', (e) => {
            if (AppState.editingTeamIndex === null) return;
            const team = AppState.teams[AppState.editingTeamIndex];
            if (e.target.id === 'close-modal-btn' || e.target.classList.contains('modal-backdrop')) {
                playerModal.classList.add('hidden');
                AppState.editingTeamIndex = null;
                renderTeamInputs();
            }
            if (e.target.id === 'add-player-btn') {
                const input = document.getElementById('new-player-name');
                if (input.value.trim()) {
                    team.players.push(input.value.trim());
                    input.value = '';
                    renderModalPlayerList();
                }
            }
            if (e.target.classList.contains('delete-player-btn')) {
                team.players.splice(e.target.dataset.playerIndex, 1);
                renderModalPlayerList();
            }
            if (e.target.classList.contains('edit-player-btn')) {
                const item = e.target.closest('div').parentElement;
                item.querySelector('.player-name').classList.add('hidden');
                item.querySelector('.edit-player-btn').classList.add('hidden');
                item.querySelector('.player-edit-input').classList.remove('hidden');
                item.querySelector('.save-player-btn').classList.remove('hidden');
            }
            if (e.target.classList.contains('save-player-btn')) {
                const item = e.target.closest('div').parentElement;
                const newName = item.querySelector('.player-edit-input').value.trim();
                if (newName) {
                    team.players[e.target.dataset.playerIndex] = newName;
                }
                renderModalPlayerList();
            }
        });

        // --- DRAG & DROP (√âTAPE 3) ---
        function setupDragAndDrop() {
            const unassignedContainer = document.getElementById('unassigned-teams');
            const poolsContainer = document.getElementById('pools-container');
            unassignedContainer.innerHTML = '';
            poolsContainer.innerHTML = '';

            AppState.teams.forEach(team => {
                unassignedContainer.innerHTML += `<div class="draggable-item p-3 bg-white border rounded-md shadow-sm" data-id="${team.id}">${team.name}</div>`;
            });

            const numGroups = AppState.teams.length < 9 ? 2 : 3;
            for (let i = 0; i < numGroups; i++) {
                poolsContainer.innerHTML += `
                    <div>
                        <h3 class="font-semibold mb-2 text-center">Poule ${String.fromCharCode(65 + i)}</h3>
                        <div id="pool-${i}" class="p-4 rounded-lg space-y-2 drop-zone pool-zone"></div>
                    </div>
                `;
            }

            new Sortable(unassignedContainer, { group: 'shared-pools', animation: 150 });
            document.querySelectorAll('.pool-zone').forEach(pool => {
                new Sortable(pool, { group: 'shared-pools', animation: 150 });
            });
        }
        
        // --- LOGIQUE DE PLANIFICATION & CALCULS ---
        function planMatches(allMatches, groups) {
            const NUM_TERRAINS = 3;
            const schedule = [];
            let shuffledMatches = [...allMatches].sort(() => Math.random() - 0.5);

            while (shuffledMatches.length > 0) {
                const currentRoundMatches = [];
                const teamsInRound = new Set();
                const availableTerrains = [1, 2, 3];

                for (let i = shuffledMatches.length - 1; i >= 0; i--) {
                    if (availableTerrains.length === 0) break;
                    const match = shuffledMatches[i];
                    if (!teamsInRound.has(match.team1) && !teamsInRound.has(match.team2)) {
                        const terrain = availableTerrains.pop();
                        const groupTeams = groups[match.groupIndex];
                        let referee = groupTeams.find(team => 
                            team !== match.team1 && team !== match.team2 && !teamsInRound.has(team)
                        ) || 'N/A';
                        
                        currentRoundMatches.push({ ...match, terrain, referee, score1: '', score2: '' });
                        teamsInRound.add(match.team1);
                        teamsInRound.add(match.team2);
                        if (referee !== 'N/A') teamsInRound.add(referee);
                        
                        shuffledMatches.splice(i, 1);
                    }
                }
                if (currentRoundMatches.length > 0) {
                    schedule.push(currentRoundMatches);
                }
            }
            return schedule;
        }

        function calculateTimings(numRounds) {
            const [startHour, startMinute] = AppState.startTime.split(':').map(Number);
            const startTime = new Date();
            startTime.setHours(startHour, startMinute, 0, 0);
            const targetEndTime = new Date(startTime);
            targetEndTime.setHours(12, 15, 0, 0);

            if (targetEndTime <= startTime || numRounds === 0) {
                 errorMessage.textContent = "L'heure de d√©but est invalide ou il n'y a pas de match √† plannifier.";
                 return {};
            }

            const totalMinutesAvailable = (targetEndTime.getTime() - startTime.getTime()) / 60000;
            const PAUSE_DURATION = 5;
            const totalSlotDuration = totalMinutesAvailable / numRounds;
            const matchDuration = Math.floor(totalSlotDuration - PAUSE_DURATION);

            if (matchDuration <= 0) {
                errorMessage.textContent = "Dur√©e de match calcul√©e n√©gative. Essayez une heure de d√©but plus pr√©coce.";
                return {};
            }
            
            document.getElementById('schedule-summary').textContent = `Dur√©e de match calcul√©e : ${matchDuration} minutes (+ ~${Math.ceil(totalSlotDuration - matchDuration)} min de pause).`;
            return { startTime, totalSlotDuration };
        }

        // --- AFFICHAGE DU PLANNING ---
        function displayGroups(groups) {
            const container = document.getElementById('groups-display');
            container.innerHTML = '';
            const colors = ['bg-blue-100', 'bg-green-100', 'bg-yellow-100'];
            groups.forEach((group, index) => {
                const groupEl = document.createElement('div');
                groupEl.className = `p-4 rounded-lg shadow ${colors[index % colors.length]}`;
                let teamsHtml = group.map(teamName => {
                    const teamData = AppState.teams.find(t => t.name === teamName);
                    const playersList = teamData && teamData.players.length > 0 
                        ? `<br><span class="text-xs text-gray-500">${teamData.players.join(', ')}</span>` 
                        : '';
                    return `<li class="text-gray-700">${teamName}${playersList}</li>`;
                }).join('');
                groupEl.innerHTML = `<h3 class="font-bold text-lg text-gray-800 mb-2">Poule ${String.fromCharCode(65 + index)}</h3><ul class="list-disc list-inside space-y-1">${teamsHtml}</ul>`;
                container.appendChild(groupEl);
            });
        }

        function displaySchedule(schedule, startTime, totalSlotDuration) {
            const body = document.getElementById('schedule-body');
            body.innerHTML = '';
            let currentTime = new Date(startTime.getTime());
            let scheduleDataForCsv = [];

            schedule.forEach((round, roundIndex) => {
                round.sort((a, b) => a.terrain - b.terrain);
                round.forEach((match, matchIndex) => {
                    const row = document.createElement('tr');
                    const matchId = `match-${roundIndex}-${matchIndex}`;
                    row.innerHTML = `
                        <td class="px-6 py-4"><div class="text-sm font-medium text-gray-900">${formatTime(currentTime)}</div></td>
                        <td class="px-6 py-4"><span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-indigo-100 text-indigo-800">Terrain ${match.terrain}</span></td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">${match.team1} <span class="font-bold text-gray-500">vs</span> ${match.team2}</div>
                            <div class="text-xs text-gray-500">Poule ${String.fromCharCode(65 + match.groupIndex)}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-2">
                                <input type="number" class="score-input w-12 text-center border rounded-md" data-match-id="${matchId}" data-team="1"><span>-</span><input type="number" class="score-input w-12 text-center border rounded-md" data-match-id="${matchId}" data-team="2">
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600">${match.referee}</td>
                    `;
                    body.appendChild(row);

                    scheduleDataForCsv.push({
                        matchId: matchId,
                        heure: formatTime(currentTime),
                        terrain: `Terrain ${match.terrain}`,
                        equipeA: match.team1,
                        equipeB: match.team2,
                        arbitre: match.referee,
                        groupe: `Poule ${String.fromCharCode(65 + match.groupIndex)}`
                    });
                });
                currentTime.setMinutes(currentTime.getMinutes() + totalSlotDuration);
            });
            AppState.scheduleDataForCsv = scheduleDataForCsv;
        }
        
        // --- FONCTIONS CSV ET UTILITAIRES ---
        function downloadCsv() {
            if (!AppState.scheduleDataForCsv || AppState.scheduleDataForCsv.length === 0) return;

            const scoreInputs = document.querySelectorAll('.score-input');
            const scoresMap = {};
            scoreInputs.forEach(input => {
                const matchId = input.dataset.matchId;
                if (!scoresMap[matchId]) scoresMap[matchId] = { score1: '', score2: '' };
                if (input.dataset.team === '1') scoresMap[matchId].score1 = input.value;
                else scoresMap[matchId].score2 = input.value;
            });

            const dataToExport = AppState.scheduleDataForCsv.map(row => {
                const matchScores = scoresMap[row.matchId];
                const score = matchScores ? `${matchScores.score1} - ${matchScores.score2}` : ' - ';
                return { ...row, score };
            });

            const headers = ['Heure', 'Terrain', '√âquipe A', '√âquipe B', 'Score', 'Arbitre', 'Groupe'];
            const csvRows = [headers.join(',')];

            dataToExport.forEach(row => {
                const values = [row.heure, row.terrain, row.equipeA, row.equipeB, row.score, row.arbitre, row.groupe];
                const escapedValues = values.map(val => `"${(val || '').toString().replace(/"/g, '""')}"`);
                csvRows.push(escapedValues.join(','));
            });

            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'planning_tournoi_volley_pro.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function formatTime(date) {
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // --- STYLES DYNAMIQUES ---
        const navBtnStyle = "px-6 py-2 text-white font-bold rounded-lg hover:scale-105 transform transition-all focus:outline-none focus:ring-4";
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.className += ` ${navBtnStyle}`;
            btn.className += btn.id.includes('back') ? ' focus:ring-gray-300' : ' focus:ring-blue-300';
        });
        const actionBtnStyle = "w-full sm:w-auto text-white font-bold py-2 px-6 rounded-lg focus:outline-none focus:ring-4 transition-all transform hover:scale-105";
        document.querySelectorAll('.action-btn').forEach(btn => btn.className += ` ${actionBtnStyle}`);
        const thStyle = "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider";
        document.querySelectorAll('.th-style').forEach(th => th.className = thStyle);
    </script>
</body>
</html>
